{"ast":null,"code":"import { proxy, subscribe as sub } from 'valtio/vanilla';\nimport { W3mFrameRpcConstants } from '@reown/appkit-wallet/utils';\nimport { getPreferredAccountType } from '../utils/ChainControllerUtil.js';\nimport { withErrorBoundary } from '../utils/withErrorBoundary.js';\nimport { BlockchainApiController } from './BlockchainApiController.js';\nimport { ChainController } from './ChainController.js';\nimport { EventsController } from './EventsController.js';\nimport { OptionsController } from './OptionsController.js';\nimport { SnackController } from './SnackController.js';\n// -- State --------------------------------------------- //\nconst state = proxy({\n  transactions: [],\n  transactionsByYear: {},\n  lastNetworkInView: undefined,\n  loading: false,\n  empty: false,\n  next: undefined\n});\n// -- Controller ---------------------------------------- //\nconst controller = {\n  state,\n  subscribe(callback) {\n    return sub(state, () => callback(state));\n  },\n  setLastNetworkInView(lastNetworkInView) {\n    state.lastNetworkInView = lastNetworkInView;\n  },\n  async fetchTransactions(accountAddress) {\n    if (!accountAddress) {\n      throw new Error(\"Transactions can't be fetched without an accountAddress\");\n    }\n    state.loading = true;\n    try {\n      const response = await BlockchainApiController.fetchTransactions({\n        account: accountAddress,\n        cursor: state.next,\n        chainId: ChainController.state.activeCaipNetwork?.caipNetworkId\n      });\n      const nonSpamTransactions = TransactionsController.filterSpamTransactions(response.data);\n      const sameChainTransactions = TransactionsController.filterByConnectedChain(nonSpamTransactions);\n      const filteredTransactions = [...state.transactions, ...sameChainTransactions];\n      state.loading = false;\n      state.transactions = filteredTransactions;\n      state.transactionsByYear = TransactionsController.groupTransactionsByYearAndMonth(state.transactionsByYear, sameChainTransactions);\n      state.empty = filteredTransactions.length === 0;\n      state.next = response.next ? response.next : undefined;\n    } catch (error) {\n      const activeChainNamespace = ChainController.state.activeChain;\n      EventsController.sendEvent({\n        type: 'track',\n        event: 'ERROR_FETCH_TRANSACTIONS',\n        properties: {\n          address: accountAddress,\n          projectId: OptionsController.state.projectId,\n          cursor: state.next,\n          isSmartAccount: getPreferredAccountType(activeChainNamespace) === W3mFrameRpcConstants.ACCOUNT_TYPES.SMART_ACCOUNT\n        }\n      });\n      SnackController.showError('Failed to fetch transactions');\n      state.loading = false;\n      state.empty = true;\n      state.next = undefined;\n    }\n  },\n  groupTransactionsByYearAndMonth(transactionsMap = {}, transactions = []) {\n    const grouped = transactionsMap;\n    transactions.forEach(transaction => {\n      const year = new Date(transaction.metadata.minedAt).getFullYear();\n      const month = new Date(transaction.metadata.minedAt).getMonth();\n      const yearTransactions = grouped[year] ?? {};\n      const monthTransactions = yearTransactions[month] ?? [];\n      // If there's a transaction with the same id, remove the old one\n      const newMonthTransactions = monthTransactions.filter(tx => tx.id !== transaction.id);\n      grouped[year] = {\n        ...yearTransactions,\n        [month]: [...newMonthTransactions, transaction].sort((a, b) => new Date(b.metadata.minedAt).getTime() - new Date(a.metadata.minedAt).getTime())\n      };\n    });\n    return grouped;\n  },\n  filterSpamTransactions(transactions) {\n    return transactions.filter(transaction => {\n      const isAllSpam = transaction.transfers.every(transfer => transfer.nft_info?.flags.is_spam === true);\n      return !isAllSpam;\n    });\n  },\n  filterByConnectedChain(transactions) {\n    const chainId = ChainController.state.activeCaipNetwork?.caipNetworkId;\n    const filteredTransactions = transactions.filter(transaction => transaction.metadata.chain === chainId);\n    return filteredTransactions;\n  },\n  clearCursor() {\n    state.next = undefined;\n  },\n  resetTransactions() {\n    state.transactions = [];\n    state.transactionsByYear = {};\n    state.lastNetworkInView = undefined;\n    state.loading = false;\n    state.empty = false;\n    state.next = undefined;\n  }\n};\n// Export the controller wrapped with our error boundary\nexport const TransactionsController = withErrorBoundary(controller, 'API_ERROR');","map":{"version":3,"names":["proxy","subscribe","sub","W3mFrameRpcConstants","getPreferredAccountType","withErrorBoundary","BlockchainApiController","ChainController","EventsController","OptionsController","SnackController","state","transactions","transactionsByYear","lastNetworkInView","undefined","loading","empty","next","controller","callback","setLastNetworkInView","fetchTransactions","accountAddress","Error","response","account","cursor","chainId","activeCaipNetwork","caipNetworkId","nonSpamTransactions","TransactionsController","filterSpamTransactions","data","sameChainTransactions","filterByConnectedChain","filteredTransactions","groupTransactionsByYearAndMonth","length","error","activeChainNamespace","activeChain","sendEvent","type","event","properties","address","projectId","isSmartAccount","ACCOUNT_TYPES","SMART_ACCOUNT","showError","transactionsMap","grouped","forEach","transaction","year","Date","metadata","minedAt","getFullYear","month","getMonth","yearTransactions","monthTransactions","newMonthTransactions","filter","tx","id","sort","a","b","getTime","isAllSpam","transfers","every","transfer","nft_info","flags","is_spam","chain","clearCursor","resetTransactions"],"sources":["../../../../src/controllers/TransactionsController.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}