{"ast":null,"code":"import { erc20Abi, formatUnits } from 'viem';\nimport { ConstantsUtil, ParseUtil } from '@reown/appkit-common';\nimport { BlockchainApiController } from '../controllers/BlockchainApiController.js';\nimport { ChainController } from '../controllers/ChainController.js';\nimport { ConnectionController } from '../controllers/ConnectionController.js';\nimport { ConnectorController } from '../controllers/ConnectorController.js';\nimport { ERC7811Utils } from './ERC7811Util.js';\nimport { StorageUtil } from './StorageUtil.js';\nimport { ViemUtil } from './ViemUtil.js';\n// -- Controller ---------------------------------------- //\nexport const BalanceUtil = {\n  /**\n   * Get the balances of the user's tokens. If user connected with Auth provider or and on the EIP155 network,\n   * it'll use the `wallet_getAssets` and `wallet_getCapabilities` calls to fetch the balance rather than Blockchain API\n   * @param forceUpdate - If true, the balances will be fetched from the server\n   * @returns The balances of the user's tokens\n   */\n  async getMyTokensWithBalance(forceUpdate) {\n    const address = ChainController.getAccountData()?.address;\n    const caipNetwork = ChainController.state.activeCaipNetwork;\n    const isAuthConnector = ConnectorController.getConnectorId('eip155') === ConstantsUtil.CONNECTOR_ID.AUTH;\n    if (!address || !caipNetwork) {\n      return [];\n    }\n    const caipAddress = `${caipNetwork.caipNetworkId}:${address}`;\n    const cachedBalance = StorageUtil.getBalanceCacheForCaipAddress(caipAddress);\n    if (cachedBalance) {\n      return cachedBalance.balances;\n    }\n    // Extract EIP-155 specific logic\n    if (caipNetwork.chainNamespace === ConstantsUtil.CHAIN.EVM && isAuthConnector) {\n      const eip155Balances = await this.getEIP155Balances(address, caipNetwork);\n      if (eip155Balances) {\n        return this.filterLowQualityTokens(eip155Balances);\n      }\n    }\n    // Fallback to 1Inch API\n    const response = await BlockchainApiController.getBalance(address, caipNetwork.caipNetworkId, forceUpdate);\n    return this.filterLowQualityTokens(response.balances);\n  },\n  /**\n   * Get the balances of the user's tokens on the EIP155 network using native `wallet_getAssets` and `wallet_getCapabilities` calls\n   * @param address - The address of the user\n   * @param caipNetwork - The CAIP network\n   * @returns The balances of the user's tokens on the EIP155 network\n   */\n  async getEIP155Balances(address, caipNetwork) {\n    try {\n      const chainIdHex = ERC7811Utils.getChainIdHexFromCAIP2ChainId(caipNetwork.caipNetworkId);\n      const walletCapabilities = await ConnectionController.getCapabilities(address);\n      if (!walletCapabilities?.[chainIdHex]?.['assetDiscovery']?.supported) {\n        return null;\n      }\n      const walletGetAssetsResponse = await ConnectionController.walletGetAssets({\n        account: address,\n        chainFilter: [chainIdHex]\n      });\n      if (!ERC7811Utils.isWalletGetAssetsResponse(walletGetAssetsResponse)) {\n        return null;\n      }\n      const assets = walletGetAssetsResponse[chainIdHex] || [];\n      const filteredAssets = assets.map(asset => ERC7811Utils.createBalance(asset, caipNetwork.caipNetworkId));\n      StorageUtil.updateBalanceCache({\n        caipAddress: `${caipNetwork.caipNetworkId}:${address}`,\n        balance: {\n          balances: filteredAssets\n        },\n        timestamp: Date.now()\n      });\n      return filteredAssets;\n    } catch (error) {\n      return null;\n    }\n  },\n  /**\n   * The 1Inch API includes many low-quality tokens in the balance response,\n   * which appear inconsistently. This filter prevents them from being displayed.\n   */\n  filterLowQualityTokens(balances) {\n    return balances.filter(balance => balance.quantity.decimals !== '0');\n  },\n  async fetchERC20Balance({\n    caipAddress,\n    assetAddress,\n    caipNetwork\n  }) {\n    const publicClient = await ViemUtil.createViemPublicClient(caipNetwork);\n    const {\n      address\n    } = ParseUtil.parseCaipAddress(caipAddress);\n    const [{\n      result: name\n    }, {\n      result: symbol\n    }, {\n      result: balance\n    }, {\n      result: decimals\n    }] = await publicClient.multicall({\n      contracts: [{\n        address: assetAddress,\n        functionName: 'name',\n        args: [],\n        abi: erc20Abi\n      }, {\n        address: assetAddress,\n        functionName: 'symbol',\n        args: [],\n        abi: erc20Abi\n      }, {\n        address: assetAddress,\n        functionName: 'balanceOf',\n        args: [address],\n        abi: erc20Abi\n      }, {\n        address: assetAddress,\n        functionName: 'decimals',\n        args: [],\n        abi: erc20Abi\n      }]\n    });\n    return {\n      name,\n      symbol,\n      decimals,\n      balance: balance && decimals ? formatUnits(balance, decimals) : '0'\n    };\n  }\n};","map":{"version":3,"names":["erc20Abi","formatUnits","ConstantsUtil","ParseUtil","BlockchainApiController","ChainController","ConnectionController","ConnectorController","ERC7811Utils","StorageUtil","ViemUtil","BalanceUtil","getMyTokensWithBalance","forceUpdate","address","getAccountData","caipNetwork","state","activeCaipNetwork","isAuthConnector","getConnectorId","CONNECTOR_ID","AUTH","caipAddress","caipNetworkId","cachedBalance","getBalanceCacheForCaipAddress","balances","chainNamespace","CHAIN","EVM","eip155Balances","getEIP155Balances","filterLowQualityTokens","response","getBalance","chainIdHex","getChainIdHexFromCAIP2ChainId","walletCapabilities","getCapabilities","supported","walletGetAssetsResponse","walletGetAssets","account","chainFilter","isWalletGetAssetsResponse","assets","filteredAssets","map","asset","createBalance","updateBalanceCache","balance","timestamp","Date","now","error","filter","quantity","decimals","fetchERC20Balance","assetAddress","publicClient","createViemPublicClient","parseCaipAddress","result","name","symbol","multicall","contracts","functionName","args","abi"],"sources":["../../../../src/utils/BalanceUtil.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}