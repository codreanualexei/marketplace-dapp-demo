{"ast":null,"code":"import { proxy, subscribe as sub } from 'valtio/vanilla';\nimport { CoreHelperUtil } from '../utils/CoreHelperUtil.js';\nimport { FetchUtil } from '../utils/FetchUtil.js';\nimport { ChainController } from './ChainController.js';\nimport { OptionsController } from './OptionsController.js';\n// -- Helpers ------------------------------------------- //\nconst baseUrl = CoreHelperUtil.getAnalyticsUrl();\nconst api = new FetchUtil({\n  baseUrl,\n  clientId: null\n});\nconst excluded = ['MODAL_CREATED'];\n// SendBeacon payload limit is 64KB, using 45KB for a safe margin, also 45KB is approx ~200 events which is plenty\nconst MAX_PENDING_EVENTS_KB = 45;\n// Flush events every 10 seconds\nconst FLUSH_EVENTS_INTERVAL_MS = 1000 * 10;\n// -- State --------------------------------------------- //\nconst state = proxy({\n  timestamp: Date.now(),\n  lastFlush: Date.now(),\n  reportedErrors: {},\n  data: {\n    type: 'track',\n    event: 'MODAL_CREATED'\n  },\n  pendingEvents: [],\n  subscribedToVisibilityChange: false,\n  walletImpressions: []\n});\n// -- Controller ---------------------------------------- //\nexport const EventsController = {\n  state,\n  subscribe(callback) {\n    return sub(state, () => callback(state));\n  },\n  getSdkProperties() {\n    const {\n      projectId,\n      sdkType,\n      sdkVersion\n    } = OptionsController.state;\n    return {\n      projectId,\n      st: sdkType,\n      sv: sdkVersion || 'html-wagmi-4.2.2'\n    };\n  },\n  shouldFlushEvents() {\n    const isOverMaxSize = JSON.stringify(state.pendingEvents).length / 1024 > MAX_PENDING_EVENTS_KB;\n    const isExpired = state.lastFlush + FLUSH_EVENTS_INTERVAL_MS < Date.now();\n    return isOverMaxSize || isExpired;\n  },\n  _setPendingEvent(payload) {\n    try {\n      let address = ChainController.getAccountData()?.address;\n      if ('address' in payload.data && payload.data.address) {\n        address = payload.data.address;\n      }\n      if (excluded.includes(payload.data.event) || typeof window === 'undefined') {\n        return;\n      }\n      const caipNetworkId = ChainController.getActiveCaipNetwork()?.caipNetworkId;\n      this.state.pendingEvents.push({\n        eventId: CoreHelperUtil.getUUID(),\n        url: window.location.href,\n        domain: window.location.hostname,\n        timestamp: payload.timestamp,\n        props: {\n          ...payload.data,\n          address,\n          properties: {\n            ...('properties' in payload.data ? payload.data.properties : {}),\n            caipNetworkId\n          }\n        }\n      });\n      state.reportedErrors['FORBIDDEN'] = false;\n      const shouldFlush = EventsController.shouldFlushEvents();\n      // If the pending events are too large, submit them as sendBeacon has a limit of 64KB\n      if (shouldFlush) {\n        EventsController._submitPendingEvents();\n      }\n    } catch (err) {\n      console.warn('_setPendingEvent', err);\n    }\n  },\n  sendEvent(data) {\n    state.timestamp = Date.now();\n    state.data = data;\n    const MANDATORY_EVENTS = ['INITIALIZE', 'CONNECT_SUCCESS', 'SOCIAL_LOGIN_SUCCESS'];\n    if (OptionsController.state.features?.analytics || MANDATORY_EVENTS.includes(data.event)) {\n      EventsController._setPendingEvent(state);\n    }\n    // Calling this function here to make sure document is ready and defined before subscribing to visibility change\n    this.subscribeToFlushTriggers();\n  },\n  /**\n   * Adds a wallet impression item to the aggregated list. These are flushed as a single\n   * WALLET_IMPRESSION batch in _submitPendingEvents.\n   */\n  sendWalletImpressionEvent(item) {\n    state.walletImpressions.push(item);\n  },\n  _transformPendingEventsForBatch(events) {\n    try {\n      return events.filter(evt => {\n        const eventName = evt.props.event;\n        return eventName !== 'WALLET_IMPRESSION';\n      });\n    } catch {\n      return events;\n    }\n  },\n  _submitPendingEvents() {\n    state.lastFlush = Date.now();\n    if (state.pendingEvents.length === 0 && state.walletImpressions.length === 0) {\n      return;\n    }\n    try {\n      const batch = EventsController._transformPendingEventsForBatch(state.pendingEvents);\n      if (state.walletImpressions.length) {\n        batch.push({\n          eventId: CoreHelperUtil.getUUID(),\n          url: window.location.href,\n          domain: window.location.hostname,\n          timestamp: Date.now(),\n          props: {\n            type: 'track',\n            event: 'WALLET_IMPRESSION',\n            items: [...state.walletImpressions]\n          }\n        });\n      }\n      api.sendBeacon({\n        path: '/batch',\n        params: EventsController.getSdkProperties(),\n        body: batch\n      });\n      state.reportedErrors['FORBIDDEN'] = false;\n      state.pendingEvents = [];\n      state.walletImpressions = [];\n    } catch (err) {\n      state.reportedErrors['FORBIDDEN'] = true;\n    }\n  },\n  subscribeToFlushTriggers() {\n    if (state.subscribedToVisibilityChange) {\n      return;\n    }\n    if (typeof document === 'undefined') {\n      return;\n    }\n    state.subscribedToVisibilityChange = true;\n    // Submit pending events when the document is hidden\n    document?.addEventListener?.('visibilitychange', () => {\n      if (document.visibilityState === 'hidden') {\n        EventsController._submitPendingEvents();\n      }\n    });\n    // Submit pending events when the document is frozen (triggered on mobile)\n    document?.addEventListener?.('freeze', () => {\n      EventsController._submitPendingEvents();\n    });\n    // Submit pending events when the window is hidden\n    window?.addEventListener?.('pagehide', () => {\n      EventsController._submitPendingEvents();\n    });\n    // Submit pending events every 10 seconds\n    setInterval(() => {\n      EventsController._submitPendingEvents();\n    }, FLUSH_EVENTS_INTERVAL_MS);\n  }\n};","map":{"version":3,"names":["proxy","subscribe","sub","CoreHelperUtil","FetchUtil","ChainController","OptionsController","baseUrl","getAnalyticsUrl","api","clientId","excluded","MAX_PENDING_EVENTS_KB","FLUSH_EVENTS_INTERVAL_MS","state","timestamp","Date","now","lastFlush","reportedErrors","data","type","event","pendingEvents","subscribedToVisibilityChange","walletImpressions","EventsController","callback","getSdkProperties","projectId","sdkType","sdkVersion","st","sv","shouldFlushEvents","isOverMaxSize","JSON","stringify","length","isExpired","_setPendingEvent","payload","address","getAccountData","includes","window","caipNetworkId","getActiveCaipNetwork","push","eventId","getUUID","url","location","href","domain","hostname","props","properties","shouldFlush","_submitPendingEvents","err","console","warn","sendEvent","MANDATORY_EVENTS","features","analytics","subscribeToFlushTriggers","sendWalletImpressionEvent","item","_transformPendingEventsForBatch","events","filter","evt","eventName","batch","items","sendBeacon","path","params","body","document","addEventListener","visibilityState","setInterval"],"sources":["../../../../src/controllers/EventsController.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}