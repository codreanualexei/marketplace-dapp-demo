{"ast":null,"code":"import _objectSpread from \"/Users/alex.codreanu/Desktop/marketplace-dapp/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";\nimport { proxy, subscribe as sub } from 'valtio/vanilla';\nimport { CoreHelperUtil } from '../utils/CoreHelperUtil.js';\nimport { FetchUtil } from '../utils/FetchUtil.js';\nimport { ChainController } from './ChainController.js';\nimport { OptionsController } from './OptionsController.js';\n// -- Helpers ------------------------------------------- //\nconst baseUrl = CoreHelperUtil.getAnalyticsUrl();\nconst api = new FetchUtil({\n  baseUrl,\n  clientId: null\n});\nconst excluded = ['MODAL_CREATED'];\n// SendBeacon payload limit is 64KB, using 45KB for a safe margin, also 45KB is approx ~200 events which is plenty\nconst MAX_PENDING_EVENTS_KB = 45;\n// Flush events every 10 seconds\nconst FLUSH_EVENTS_INTERVAL_MS = 1000 * 10;\n// -- State --------------------------------------------- //\nconst state = proxy({\n  timestamp: Date.now(),\n  lastFlush: Date.now(),\n  reportedErrors: {},\n  data: {\n    type: 'track',\n    event: 'MODAL_CREATED'\n  },\n  pendingEvents: [],\n  subscribedToVisibilityChange: false,\n  walletImpressions: []\n});\n// -- Controller ---------------------------------------- //\nexport const EventsController = {\n  state,\n  subscribe(callback) {\n    return sub(state, () => callback(state));\n  },\n  getSdkProperties() {\n    const {\n      projectId,\n      sdkType,\n      sdkVersion\n    } = OptionsController.state;\n    return {\n      projectId,\n      st: sdkType,\n      sv: sdkVersion || 'html-wagmi-4.2.2'\n    };\n  },\n  shouldFlushEvents() {\n    const isOverMaxSize = JSON.stringify(state.pendingEvents).length / 1024 > MAX_PENDING_EVENTS_KB;\n    const isExpired = state.lastFlush + FLUSH_EVENTS_INTERVAL_MS < Date.now();\n    return isOverMaxSize || isExpired;\n  },\n  _setPendingEvent(payload) {\n    try {\n      var _ChainController$getA, _ChainController$getA2;\n      let address = (_ChainController$getA = ChainController.getAccountData()) === null || _ChainController$getA === void 0 ? void 0 : _ChainController$getA.address;\n      if ('address' in payload.data && payload.data.address) {\n        address = payload.data.address;\n      }\n      if (excluded.includes(payload.data.event) || typeof window === 'undefined') {\n        return;\n      }\n      const caipNetworkId = (_ChainController$getA2 = ChainController.getActiveCaipNetwork()) === null || _ChainController$getA2 === void 0 ? void 0 : _ChainController$getA2.caipNetworkId;\n      this.state.pendingEvents.push({\n        eventId: CoreHelperUtil.getUUID(),\n        url: window.location.href,\n        domain: window.location.hostname,\n        timestamp: payload.timestamp,\n        props: _objectSpread(_objectSpread({}, payload.data), {}, {\n          address,\n          properties: _objectSpread(_objectSpread({}, 'properties' in payload.data ? payload.data.properties : {}), {}, {\n            caipNetworkId\n          })\n        })\n      });\n      state.reportedErrors['FORBIDDEN'] = false;\n      const shouldFlush = EventsController.shouldFlushEvents();\n      // If the pending events are too large, submit them as sendBeacon has a limit of 64KB\n      if (shouldFlush) {\n        EventsController._submitPendingEvents();\n      }\n    } catch (err) {\n      console.warn('_setPendingEvent', err);\n    }\n  },\n  sendEvent(data) {\n    var _OptionsController$st;\n    state.timestamp = Date.now();\n    state.data = data;\n    const MANDATORY_EVENTS = ['INITIALIZE', 'CONNECT_SUCCESS', 'SOCIAL_LOGIN_SUCCESS'];\n    if ((_OptionsController$st = OptionsController.state.features) !== null && _OptionsController$st !== void 0 && _OptionsController$st.analytics || MANDATORY_EVENTS.includes(data.event)) {\n      EventsController._setPendingEvent(state);\n    }\n    // Calling this function here to make sure document is ready and defined before subscribing to visibility change\n    this.subscribeToFlushTriggers();\n  },\n  /**\n   * Adds a wallet impression item to the aggregated list. These are flushed as a single\n   * WALLET_IMPRESSION batch in _submitPendingEvents.\n   */\n  sendWalletImpressionEvent(item) {\n    state.walletImpressions.push(item);\n  },\n  _transformPendingEventsForBatch(events) {\n    try {\n      return events.filter(evt => {\n        const eventName = evt.props.event;\n        return eventName !== 'WALLET_IMPRESSION';\n      });\n    } catch (_unused) {\n      return events;\n    }\n  },\n  _submitPendingEvents() {\n    state.lastFlush = Date.now();\n    if (state.pendingEvents.length === 0 && state.walletImpressions.length === 0) {\n      return;\n    }\n    try {\n      const batch = EventsController._transformPendingEventsForBatch(state.pendingEvents);\n      if (state.walletImpressions.length) {\n        batch.push({\n          eventId: CoreHelperUtil.getUUID(),\n          url: window.location.href,\n          domain: window.location.hostname,\n          timestamp: Date.now(),\n          props: {\n            type: 'track',\n            event: 'WALLET_IMPRESSION',\n            items: [...state.walletImpressions]\n          }\n        });\n      }\n      api.sendBeacon({\n        path: '/batch',\n        params: EventsController.getSdkProperties(),\n        body: batch\n      });\n      state.reportedErrors['FORBIDDEN'] = false;\n      state.pendingEvents = [];\n      state.walletImpressions = [];\n    } catch (err) {\n      state.reportedErrors['FORBIDDEN'] = true;\n    }\n  },\n  subscribeToFlushTriggers() {\n    var _document, _document$addEventLis, _document2, _document2$addEventLi, _window, _window$addEventListe;\n    if (state.subscribedToVisibilityChange) {\n      return;\n    }\n    if (typeof document === 'undefined') {\n      return;\n    }\n    state.subscribedToVisibilityChange = true;\n    // Submit pending events when the document is hidden\n    (_document = document) === null || _document === void 0 || (_document$addEventLis = _document.addEventListener) === null || _document$addEventLis === void 0 || _document$addEventLis.call(_document, 'visibilitychange', () => {\n      if (document.visibilityState === 'hidden') {\n        EventsController._submitPendingEvents();\n      }\n    });\n    // Submit pending events when the document is frozen (triggered on mobile)\n    (_document2 = document) === null || _document2 === void 0 || (_document2$addEventLi = _document2.addEventListener) === null || _document2$addEventLi === void 0 || _document2$addEventLi.call(_document2, 'freeze', () => {\n      EventsController._submitPendingEvents();\n    });\n    // Submit pending events when the window is hidden\n    (_window = window) === null || _window === void 0 || (_window$addEventListe = _window.addEventListener) === null || _window$addEventListe === void 0 || _window$addEventListe.call(_window, 'pagehide', () => {\n      EventsController._submitPendingEvents();\n    });\n    // Submit pending events every 10 seconds\n    setInterval(() => {\n      EventsController._submitPendingEvents();\n    }, FLUSH_EVENTS_INTERVAL_MS);\n  }\n};","map":{"version":3,"names":["proxy","subscribe","sub","CoreHelperUtil","FetchUtil","ChainController","OptionsController","baseUrl","getAnalyticsUrl","api","clientId","excluded","MAX_PENDING_EVENTS_KB","FLUSH_EVENTS_INTERVAL_MS","state","timestamp","Date","now","lastFlush","reportedErrors","data","type","event","pendingEvents","subscribedToVisibilityChange","walletImpressions","EventsController","callback","getSdkProperties","projectId","sdkType","sdkVersion","st","sv","shouldFlushEvents","isOverMaxSize","JSON","stringify","length","isExpired","_setPendingEvent","payload","_ChainController$getA","_ChainController$getA2","address","getAccountData","includes","window","caipNetworkId","getActiveCaipNetwork","push","eventId","getUUID","url","location","href","domain","hostname","props","_objectSpread","properties","shouldFlush","_submitPendingEvents","err","console","warn","sendEvent","_OptionsController$st","MANDATORY_EVENTS","features","analytics","subscribeToFlushTriggers","sendWalletImpressionEvent","item","_transformPendingEventsForBatch","events","filter","evt","eventName","_unused","batch","items","sendBeacon","path","params","body","_document","_document$addEventLis","_document2","_document2$addEventLi","_window","_window$addEventListe","document","addEventListener","call","visibilityState","setInterval"],"sources":["../../../../src/controllers/EventsController.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}