{"ast":null,"code":"import _objectSpread from \"/Users/alex.codreanu/Desktop/marketplace-dapp/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";\nimport { proxy, subscribe as sub } from 'valtio/vanilla';\nimport { W3mFrameRpcConstants } from '@reown/appkit-wallet/utils';\nimport { getPreferredAccountType } from '../utils/ChainControllerUtil.js';\nimport { withErrorBoundary } from '../utils/withErrorBoundary.js';\nimport { BlockchainApiController } from './BlockchainApiController.js';\nimport { ChainController } from './ChainController.js';\nimport { EventsController } from './EventsController.js';\nimport { OptionsController } from './OptionsController.js';\nimport { SnackController } from './SnackController.js';\n// -- State --------------------------------------------- //\nconst state = proxy({\n  transactions: [],\n  transactionsByYear: {},\n  lastNetworkInView: undefined,\n  loading: false,\n  empty: false,\n  next: undefined\n});\n// -- Controller ---------------------------------------- //\nconst controller = {\n  state,\n  subscribe(callback) {\n    return sub(state, () => callback(state));\n  },\n  setLastNetworkInView(lastNetworkInView) {\n    state.lastNetworkInView = lastNetworkInView;\n  },\n  async fetchTransactions(accountAddress) {\n    if (!accountAddress) {\n      throw new Error(\"Transactions can't be fetched without an accountAddress\");\n    }\n    state.loading = true;\n    try {\n      var _ChainController$stat;\n      const response = await BlockchainApiController.fetchTransactions({\n        account: accountAddress,\n        cursor: state.next,\n        chainId: (_ChainController$stat = ChainController.state.activeCaipNetwork) === null || _ChainController$stat === void 0 ? void 0 : _ChainController$stat.caipNetworkId\n      });\n      const nonSpamTransactions = TransactionsController.filterSpamTransactions(response.data);\n      const sameChainTransactions = TransactionsController.filterByConnectedChain(nonSpamTransactions);\n      const filteredTransactions = [...state.transactions, ...sameChainTransactions];\n      state.loading = false;\n      state.transactions = filteredTransactions;\n      state.transactionsByYear = TransactionsController.groupTransactionsByYearAndMonth(state.transactionsByYear, sameChainTransactions);\n      state.empty = filteredTransactions.length === 0;\n      state.next = response.next ? response.next : undefined;\n    } catch (error) {\n      const activeChainNamespace = ChainController.state.activeChain;\n      EventsController.sendEvent({\n        type: 'track',\n        event: 'ERROR_FETCH_TRANSACTIONS',\n        properties: {\n          address: accountAddress,\n          projectId: OptionsController.state.projectId,\n          cursor: state.next,\n          isSmartAccount: getPreferredAccountType(activeChainNamespace) === W3mFrameRpcConstants.ACCOUNT_TYPES.SMART_ACCOUNT\n        }\n      });\n      SnackController.showError('Failed to fetch transactions');\n      state.loading = false;\n      state.empty = true;\n      state.next = undefined;\n    }\n  },\n  groupTransactionsByYearAndMonth() {\n    let transactionsMap = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    let transactions = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];\n    const grouped = transactionsMap;\n    transactions.forEach(transaction => {\n      var _grouped$year, _yearTransactions$mon;\n      const year = new Date(transaction.metadata.minedAt).getFullYear();\n      const month = new Date(transaction.metadata.minedAt).getMonth();\n      const yearTransactions = (_grouped$year = grouped[year]) !== null && _grouped$year !== void 0 ? _grouped$year : {};\n      const monthTransactions = (_yearTransactions$mon = yearTransactions[month]) !== null && _yearTransactions$mon !== void 0 ? _yearTransactions$mon : [];\n      // If there's a transaction with the same id, remove the old one\n      const newMonthTransactions = monthTransactions.filter(tx => tx.id !== transaction.id);\n      grouped[year] = _objectSpread(_objectSpread({}, yearTransactions), {}, {\n        [month]: [...newMonthTransactions, transaction].sort((a, b) => new Date(b.metadata.minedAt).getTime() - new Date(a.metadata.minedAt).getTime())\n      });\n    });\n    return grouped;\n  },\n  filterSpamTransactions(transactions) {\n    return transactions.filter(transaction => {\n      const isAllSpam = transaction.transfers.every(transfer => {\n        var _transfer$nft_info;\n        return ((_transfer$nft_info = transfer.nft_info) === null || _transfer$nft_info === void 0 ? void 0 : _transfer$nft_info.flags.is_spam) === true;\n      });\n      return !isAllSpam;\n    });\n  },\n  filterByConnectedChain(transactions) {\n    var _ChainController$stat2;\n    const chainId = (_ChainController$stat2 = ChainController.state.activeCaipNetwork) === null || _ChainController$stat2 === void 0 ? void 0 : _ChainController$stat2.caipNetworkId;\n    const filteredTransactions = transactions.filter(transaction => transaction.metadata.chain === chainId);\n    return filteredTransactions;\n  },\n  clearCursor() {\n    state.next = undefined;\n  },\n  resetTransactions() {\n    state.transactions = [];\n    state.transactionsByYear = {};\n    state.lastNetworkInView = undefined;\n    state.loading = false;\n    state.empty = false;\n    state.next = undefined;\n  }\n};\n// Export the controller wrapped with our error boundary\nexport const TransactionsController = withErrorBoundary(controller, 'API_ERROR');","map":{"version":3,"names":["proxy","subscribe","sub","W3mFrameRpcConstants","getPreferredAccountType","withErrorBoundary","BlockchainApiController","ChainController","EventsController","OptionsController","SnackController","state","transactions","transactionsByYear","lastNetworkInView","undefined","loading","empty","next","controller","callback","setLastNetworkInView","fetchTransactions","accountAddress","Error","_ChainController$stat","response","account","cursor","chainId","activeCaipNetwork","caipNetworkId","nonSpamTransactions","TransactionsController","filterSpamTransactions","data","sameChainTransactions","filterByConnectedChain","filteredTransactions","groupTransactionsByYearAndMonth","length","error","activeChainNamespace","activeChain","sendEvent","type","event","properties","address","projectId","isSmartAccount","ACCOUNT_TYPES","SMART_ACCOUNT","showError","transactionsMap","arguments","grouped","forEach","transaction","_grouped$year","_yearTransactions$mon","year","Date","metadata","minedAt","getFullYear","month","getMonth","yearTransactions","monthTransactions","newMonthTransactions","filter","tx","id","_objectSpread","sort","a","b","getTime","isAllSpam","transfers","every","transfer","_transfer$nft_info","nft_info","flags","is_spam","_ChainController$stat2","chain","clearCursor","resetTransactions"],"sources":["../../../../src/controllers/TransactionsController.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}